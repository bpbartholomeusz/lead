define("local_booking/modal_logentry_form",["exports","jquery","core_form/events","core/str","core/notification","core/custom_interaction_events","core/modal","core/fragment","local_booking/repository","local_booking/events","local_booking/selectors"],(function(_exports,_jquery,FormEvents,Str,Notification,CustomEvents,_modal,Fragment,Repository,LogbookEvents,Selectors){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * This module handles logbook entry form.
   *
   * @module     local_booking/modal_logentry_form
   * @author     Mustafa Hajjar (mustafahajjar@gmail.com)
   * @copyright  BAVirtual.co.uk Â© 2021
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),FormEvents=_interopRequireWildcard(FormEvents),Str=_interopRequireWildcard(Str),Notification=_interopRequireWildcard(Notification),CustomEvents=_interopRequireWildcard(CustomEvents),_modal=_interopRequireDefault(_modal),Fragment=_interopRequireWildcard(Fragment),Repository=_interopRequireWildcard(Repository),LogbookEvents=_interopRequireWildcard(LogbookEvents),Selectors=_interopRequireWildcard(Selectors);var SELECTORS_SAVE_BUTTON='[data-action="save"]',SELECTORS_LOADING_ICON_CONTAINER='[data-region="loading-icon-container"]';class ModalLogEntryForm extends _modal.default{static TYPE="local_booking-modal_logentry_form";static TEMPLATE="local_booking/modal_logentry_form";constructor(root){super(root),this.contextId=null,this.courseId=null,this.userId=null,this.logentryId=null,this.flightDate=null,this.exerciseId=null,this.sessionId=null,this.pirepLookupId=null,this.hasfindpirep=!1,this.reloadingBody=!1,this.reloadingTitle=!1,this.saveButton=this.getFooter().find(SELECTORS_SAVE_BUTTON)}configure(modalConfig){modalConfig.large=!0,super.configure(modalConfig)}setContextId(id){this.contextId=id}getContextId(){return this.contextId}setCourseId(id){this.courseId=id}getCourseId(){return this.courseId}hasCourseId(){return null!==this.courseId}setExerciseId(id){this.exerciseId=id}getExerciseId(){return this.exerciseId}hasExerciseId(){return null!==this.exerciseId}setSessionId(id){this.sessionId=id}getSessionId(){return this.sessionId}hasSessionId(){return null!==this.sessionId}setUserId(id){this.userId=id}getUserId(){return this.userId}hasUserId(){return null!==this.userId}setLogentryId(id){this.logentryId=id}getLogentryId(){return this.logentryId}hasLogentryId(){return null!==this.logentryId&&0!=this.logentryId}setFlightDate(time){this.flightDate=time}getFlightDate(){return this.flightDate}hasFlightDate(){return null!==this.flightDate}setFlightType(flighttype){this.flightType=flighttype}getFlightType(){return this.flightType}hasFindPIREP(hasfindpirep){return void 0!==hasfindpirep&&(this.hasfindpirep=hasfindpirep),this.hasfindpirep}getForm(){return this.getBody().find("form")}disableButtons(){this.saveButton.prop("disabled",!0)}enableButtons(){this.saveButton.prop("disabled",!1)}reloadTitleContent(){return this.reloadingTitle||(this.reloadingTitle=!0,this.titlePromise=Repository.getExerciseName(this.courseId,this.exerciseId).then((function(response){return""==response.exercisename?"New logentry":response.exercisename})).fail(Notification.exception),this.titlePromise.then(function(string){return this.setTitle(string),string}.bind(this)).always(function(){this.reloadingTitle=!1}.bind(this)).fail(Notification.exception)),this.titlePromise}reloadBodyContent(formData){if(this.reloadingBody)return this.bodyPromise;this.reloadingBody=!0,this.disableButtons();var args={};return this.hasUserId()&&(args.userid=this.getUserId()),this.hasLogentryId()&&(args.logentryid=this.getLogentryId()),this.hasFlightDate()&&(args.flightdate=this.getFlightDate()),this.hasCourseId()&&(args.courseid=this.getCourseId()),this.hasExerciseId()&&(args.exerciseid=this.getExerciseId()),this.hasSessionId()&&(args.sessionid=this.getSessionId()),void 0!==formData&&(args.formdata=formData),this.bodyPromise=Fragment.loadFragment("local_booking","logentry_form",this.getContextId(),args),this.setBody(this.bodyPromise),this.bodyPromise.then(function(){if(this.hasFindPIREP()&&!(0,_jquery.default)("#id_error2_p1pirep").length){let p1pirep=(0,_jquery.default)("#id_p1pirep");p1pirep.parent().prepend('<div class="input-group" id="id_pirepgroup">'),(0,_jquery.default)("#id_pirepgroup").append(p1pirep),(0,_jquery.default)("#id_pirepgroup").append('<div class="input-group-append" id="id_find_pirep">'),(0,_jquery.default)("#id_find_pirep").append('<button type="button" class="btn btn-primary search-icon"><i class="icon fa fa-search fa-fw " aria-hidden="true"></i></button>')}this.doDynamicDisplay(),this.enableButtons(),this.setInputMask(),this.registerChangeListeners()}.bind(this)).fail(Notification.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(Notification.exception),this.bodyPromise}setInputMask(){"Dual"==(0,_jquery.default)(Selectors.bookingwrapper).data("trainingtype")?Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_dualtime")):"Multicrew"==(0,_jquery.default)(Selectors.bookingwrapper).data("trainingtype")&&Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_multipilottime")),"check"==(0,_jquery.default)("input[name='flighttypehidden']").val()?Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_picustime")):"solo"==(0,_jquery.default)("input[name='flighttypehidden']").val()?Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_flighttime")):Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_groundtime")),Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_flighttime")),Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_deptime")),Inputmask({regex:"^([01]?[0-9]|2[0-3]):[0-5][0-9]"}).mask(document.getElementById("id_arrtime")),Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_nighttime")),Inputmask({regex:"^([0]?[0-4]):([0-5]?[0-9])$"}).mask(document.getElementById("id_ifrtime")),Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1day")),Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp1night")),0==this.getLogentryId()&&(Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2day")),Inputmask({regex:"[0-9]"}).mask(document.getElementById("id_landingsp2night")))}registerChangeListeners(){this.hasFindPIREP()&&(0,_jquery.default)("#id_find_pirep").on("click",function(e){return!isNaN((0,_jquery.default)("#id_p1pirep").val())&&this.getPIREPData(e)}.bind(this));(0,_jquery.default)("#id_exercises").on("change",function(){let $exerciseid=(0,_jquery.default)("#id_exercises").val();(0,_jquery.default)("input[name='exerciseid']").val($exerciseid),$exerciseid==(0,_jquery.default)("input[name='graduationexerciseid']").val()?(0,_jquery.default)("input[name='flighttypehidden']").val("check"):(0,_jquery.default)("input[name='flighttypehidden']").val((0,_jquery.default)("input[name='flighttype']:checked").val()),this.doDynamicDisplay()}.bind(this)),(0,_jquery.default)('input[name="flighttype"]').on("change",function(){(0,_jquery.default)("input[name='flighttypehidden']").val((0,_jquery.default)("input[name='flighttype']:checked").val()),this.doDynamicDisplay(),this.applyFlightTimes()}.bind(this)),(0,_jquery.default)('input[name="passfail"]').on("change",function(){(0,_jquery.default)("input[name='flighttypehidden']").val("check"),this.doDynamicDisplay(),this.applyFlightTimes()}.bind(this)),(0,_jquery.default)('input[name="flightrule"]').on("change",function(){this.doDynamicDisplay(),this.applyFlightTimes()}.bind(this)),document.getElementById("id_flighttime").onchange=function(){return this.applyFlightTimes(!0)}.bind(this)}getPIREPData(e){var loadingContainer=this.getFooter().find(SELECTORS_LOADING_ICON_CONTAINER),pirepdiv=(0,_jquery.default)("#id_p1pirep").parent(),pirep=(0,_jquery.default)("#id_p1pirep").val(),courseid=this.getCourseId(),exerciseid=this.getExerciseId();return""!=pirep?(loadingContainer.removeClass("hidden"),Repository.findPirep(pirep,courseid,(0,_jquery.default)("#id_p1id").val(),exerciseid).then(function(response){if((0,_jquery.default)("#id_p1pirep").removeClass("is-invalid"),response.result){(0,_jquery.default)("#id_valid_p1pirep").length||Str.get_string("pirepfound","local_booking").then((function(string){return pirepdiv.append('<div class="form-control-feedback valid-feedback" id="id_valid_p1pirep" tabindex="0" style="">'+string+"</div>"),(0,_jquery.default)("#id_p1pirep").addClass("is-valid"),string})).fail(Notification.exception);var d=new Date(1e3*response.logentry.flightdate),month=""+(d.getMonth()+1),day=""+d.getDate(),year=d.getFullYear(),time=response.logentry.deptime,hour=time.substring(0,2),minute=time.substring(time.indexOf(":")+1,time.length);(0,_jquery.default)("#id_flightdate_day").val(day),(0,_jquery.default)("#id_flightdate_month").val(month),(0,_jquery.default)("#id_flightdate_year").val(year),(0,_jquery.default)("#id_flightdate_hour").val(hour),(0,_jquery.default)("#id_flightdate_minute").val(minute),(0,_jquery.default)('input[name="linkedpirep"]').val(response.logentry.linkedpirep),(0,_jquery.default)("#id_flighttime").val(response.logentry.flighttime),(0,_jquery.default)("#id_depicao").val(response.logentry.depicao),(0,_jquery.default)("#id_arricao").val(response.logentry.arricao),(0,_jquery.default)("#id_deptime").val(response.logentry.deptime),(0,_jquery.default)("#id_arrtime").val(response.logentry.arrtime),(0,_jquery.default)("#id_callsign").val(response.logentry.callsign),(0,_jquery.default)("#id_aircraft").val(response.logentry.aircraft),(0,_jquery.default)("#id_aircraftreg").val(response.logentry.aircraftreg),(0,_jquery.default)("#id_enginetype").val(response.logentry.enginetype),(0,_jquery.default)("#id_route").val(response.logentry.route),(0,_jquery.default)("#id_fstd").val(response.logentry.fstd),this.doDynamicDisplay(),this.applyFlightTimes()}else(0,_jquery.default)("#id_p1pirep").addClass("is-invalid"),(0,_jquery.default)("#id_error2_p1pirep").length?(0,_jquery.default)("#id_error2_p1pirep").show():(pirepdiv.append('<div class="form-control-feedback invalid-feedback" id="id_error2_p1pirep" tabindex="0" style="">'+response.warnings[0].message+"</div>"),(0,_jquery.default)("#id_p1pirep").val(""),(0,_jquery.default)("#id_p1pirep").focus()),this.hasFindPIREP()&&(0,_jquery.default)("#id_p1pirep").parent().each((function(){(0,_jquery.default)("#id_find_pirep").insertAfter((0,_jquery.default)("#id_p1pirep"),this)}))}.bind(this)).always((function(){loadingContainer.addClass("hidden"),e.preventDefault(),e.stopPropagation()})).fail(Notification.exception)):""}applyFlightTimes(force){let rule=(0,_jquery.default)(Selectors.bookingwrapper).data("trainingtype");void 0===rule&&(rule=(0,_jquery.default)("input[name='trainingtype']").val());var flighttype=(0,_jquery.default)("input[name='flighttypehidden']").val(),flighttime=(0,_jquery.default)("#id_flighttime").val(),passfail=(0,_jquery.default)("input[name='passfail']:checked").val(),ifr="ifr"==(0,_jquery.default)("input[name='flightrule']:checked").val();(!(0!=this.getLogentryId())||force)&&("training"==flighttype||"check"==flighttype&&"fail"==passfail?((0,_jquery.default)("#id_dualtime").val("Dual"==rule?flighttime:""),(0,_jquery.default)("#id_ifrtime").val(ifr?flighttime:""),(0,_jquery.default)("#id_multipilottime").val("Multicrew"==rule?flighttime:""),(0,_jquery.default)("#id_copilottime").val("Multicrew"==rule?flighttime:""),(0,_jquery.default)("#id_checkpilottime").val("check"==flighttype?flighttime:""),(0,_jquery.default)("#id_picustime").val("")):"solo"==flighttype?((0,_jquery.default)("#id_ifrtime").val(ifr?flighttime:""),(0,_jquery.default)("#id_dualtime").val(""),(0,_jquery.default)("#id_multipilottime").val(""),(0,_jquery.default)("#id_copilottime").val(""),(0,_jquery.default)("#id_picustime").val("")):"check"!=flighttype&&"pass"!=passfail||((0,_jquery.default)("#id_ifrtime").val(ifr?flighttime:""),(0,_jquery.default)("#id_picustime").val(flighttime),(0,_jquery.default)("#id_checkpilottime").val(flighttime),(0,_jquery.default)("#id_multipilottime").val("Multicrew"==rule?flighttime:""),(0,_jquery.default)("#id_dualtime").val(""),(0,_jquery.default)("#id_copilottime").val("")))}doDynamicDisplay(){let rule=(0,_jquery.default)(Selectors.bookingwrapper).data("trainingtype");void 0===rule&&(rule=(0,_jquery.default)("input[name='trainingtype']").val());var flighttype=(0,_jquery.default)("input[name='flighttypehidden']").val(),passfail=(0,_jquery.default)("input[name='passfail']:checked").val(),editmode=0!=this.getLogentryId(),toggle=function(div,element,show,value){let force=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(void 0!==div&&void 0!==element){var ariaexpanded=this.getForm().find('[aria-expanded="true"]').attr("aria-expanded");(ariaexpanded||force)&&(show?(0,_jquery.default)(div).slideDown("fast"):(0,_jquery.default)(div).slideUp("fast")),void 0!==value&&(0,_jquery.default)(element).val(value)}}.bind(this),setLabel=function(element,editlabelkey,labelkey){editmode?Str.get_string(editlabelkey,"local_booking").then((function(label){return(0,_jquery.default)(element).text(label),label})).fail(Notification.exception):Str.get_string(labelkey,"local_booking").then((function(label){return(0,_jquery.default)(element).text(label),label})).fail(Notification.exception)};if("training"==flighttype||"check"==flighttype&&"fail"==passfail){let p1label;p1label="training"==flighttype||editmode?"Dual"==rule?"p1dual":"p1multicrew":"examiner",setLabel("label[for='id_p1pirep']","pirep","training"==flighttype?"instpirep":"examinerpirep"),setLabel("label[for='id_p1id']",p1label,p1label),toggle("#fitem_id_p2id","#id_p2id",!0),toggle("#fitem_id_groundtime","#id_groundtime",!0,(0,_jquery.default)("#id_groundtime").val(),!0),toggle("#fitem_id_dualtime","#id_dualtime",!0),toggle("#fitem_id_checkpilottime","#id_checkpilottime",!1),toggle("#fitem_id_picustime","#id_picustime",!1)}else"solo"==flighttype?(setLabel("label[for='id_p1pirep']","logbooksolopirep","logbooksolopirep"),setLabel("label[for='id_p1id']","p2dual","p2dual"),editmode||(0,_jquery.default)("#id_p1id").val((0,_jquery.default)("#id_p2id").val()),(0,_jquery.default)("#id_landingsp1day").val("1"),(0,_jquery.default)("#id_landingsp2day").val("0"),toggle("#fitem_id_p2id","#id_p2id",!1,(0,_jquery.default)("#id_p2id").val(),!0),toggle("#fitem_id_groundtime","#id_groundtime",!1,"",!0),toggle("#fitem_id_dualtime","#id_dualtime",!1),toggle("#fitem_id_checkpilottime","#id_checkpilottime",!1),toggle("#fitem_id_picustime","#id_picustime",!1),toggle("#fgroup_id_landingsp2","#id_landingsp2",!1)):"check"!=flighttype&&"pass"!=passfail||(setLabel("label[for='id_p1pirep']","pirep","examinerpirep"),setLabel("label[for='id_p1id']","examiner","examiner"),toggle("#fitem_id_p2id","#id_p2id",!0),toggle("#fitem_id_groundtime","#id_groundtime",!1,"",!0),toggle("#fitem_id_dualtime","#id_dualtime",!1),toggle("#fitem_id_checkpilottime","#id_checkpilottime",!0),toggle("#fitem_id_picustime","#id_picustime",!0))}reloadAllContent(){return _jquery.default.when(this.reloadTitleContent(),this.reloadBodyContent())}show(){this.reloadAllContent(),_modal.default.prototype.show.call(this)}hide(){_modal.default.prototype.hide.call(this),this.setLogentryId(null),this.setFlightDate(null),this.setContextId(null),this.setCourseId(null),this.setExerciseId(null),this.setSessionId(null)}getFormData(){return this.getForm().serialize()}save(){var invalid,loadingContainer=this.saveButton.find(SELECTORS_LOADING_ICON_CONTAINER);if("training"!=(0,_jquery.default)("input[name='flighttypehidden']").val()&&(0,_jquery.default)("#id_groundtime").val("00:00"),!(invalid=this.getForm().find('[aria-invalid="true"]')).length){loadingContainer.removeClass("hidden"),this.disableButtons();var formData=this.getFormData(),formArgs="contextid="+this.contextId+"&courseid="+this.courseId+"&exerciseid="+this.exerciseId+"&sessionid="+this.sessionId+"&userid="+this.userId;return Repository.submitCreateUpdateLogentryForm(formArgs,formData).then(function(response){if(response.validationerror)this.reloadBodyContent(formData);else{var isExisting=this.hasLogentryId();this.hide(),isExisting?(0,_jquery.default)("body").trigger(LogbookEvents.logentryupdated,[response.logentry]):(0,_jquery.default)("body").trigger(LogbookEvents.logentrycreated,[response.logentry])}}.bind(this)).always(function(){loadingContainer.addClass("hidden"),Notification.fetchNotifications(),this.enableButtons()}.bind(this)).fail(Notification.exception)}invalid.first().focus()}registerEventListeners(){_modal.default.prototype.registerEventListeners.call(this),this.getModal().on(CustomEvents.events.activate,SELECTORS_SAVE_BUTTON,function(e,data){this.getForm().submit(),data.originalEvent.preventDefault(),e.stopPropagation()}.bind(this)),this.getModal().on("submit",function(e){FormEvents.notifyFormSubmittedByJavascript(this.getForm()[0]),this.save(),e.preventDefault(),e.stopPropagation()}.bind(this)),this.getModal().on("click","a[aria-expanded]",function(){setTimeout(function(){this.doDynamicDisplay()}.bind(this),100)}.bind(this))}}return _exports.default=ModalLogEntryForm,ModalLogEntryForm.registerModalType(),_exports.default}));

//# sourceMappingURL=modal_logentry_form.min.js.map